# @Author(s): Eric Top, Enkhbold Nyamsuren, Simon Scheider, 
@prefix ccd: <http://geographicknowledge.de/vocab/CoreConceptData.rdf#> .
@prefix cct: <https://github.com/quangis/cct#> .
@prefix data: <https://github.com/quangis/cct/blob/master/tools/data.ttl#> .
@prefix dct: <http://purl.org/dc/terms/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix tools: <https://github.com/quangis/cct/blob/master/tools/tools.ttl#> .
@prefix wf: <http://geographicknowledge.de/vocab/Workflow.rdf#> .

tools:wfwalk_residentialdensity a wf:Workflow ;
    wf:edge data:n15,
        data:n20,
        data:n29,
        data:n50 ;
    wf:source data:Amsterdam_buurt,
        data:Amsterdam_land,
        data:households ;
    rdfs:comment "What is the density of residential areas for each neighbourhood in Amsterdam" .

data:n0 wf:applicationOf tools:CopyFeatures ;
    wf:input1 data:Amsterdam_buurt ;
    wf:output data:buurten ;
    rdfs:comment "Copy vector polygons representing buurten of Amsterdam to local file" .

data:n11 wf:applicationOf tools:AddField ;
    wf:input1 data:buurten_HH_Temp ;
    wf:output data:buurten_HH_Temp2 ;
    rdfs:comment "Add field for household count data to an attribute in the buurten attribute table" .

data:n13 wf:applicationOf tools:CalculateField ;
    wf:input1 data:buurten_HH_Temp2 ;
    wf:output data:buurten_HH ;
    rdfs:comment "Copy household count data to an attribute in the buurten attribute table" .

data:n15 wf:applicationOf tools:SelectLayerByAttribute ;
    wf:input1 data:Amsterdam_land ;
    wf:output data:residential_area ;
    rdfs:comment "Select residential area in Amsterdam" ;
    cct:expression "['revert (select eq (invert (1: Field(Nom)): Coverages(Nom)) (-: Nom))']" .

data:n20 wf:applicationOf tools:SummarizeWithin ;
    wf:input2 data:residential_area ;
    wf:input3 data:buurten ;
    wf:output data:buurten_HH_RA ;
    rdfs:comment "Sum residential area size in each neighbourhood" ;
    cct:expression "['    1: Field(Nom);\\n    2: ObjectInfo(Nom);\\n    join_attr\\n            (get_attrL 2)\\n            (apply1 \\n                (compose size pi1) \\n                (apply1 \\n                    (compose (subset (1)) deify) \\n                    (get_attrL 2)\\n                )\\n            )']" .

data:n21 wf:applicationOf tools:AddField ;
    wf:input1 data:buurten_HH_RA ;
    wf:output data:buurten_HH_RA2 ;
    rdfs:comment "Add a residential density attribute" .

data:n22 wf:applicationOf tools:CalculateField ;
    wf:input1 data:buurten_HH ;
    wf:input2 data:buurten_HH_RA2 ;
    wf:output data:buurten_res_dens ;
    rdfs:comment "Calculate residential density" .

data:n29 wf:applicationOf tools:LoadCountAmounts ;
    wf:input2 data:households ;
    wf:input3 data:Amsterdam_buurt ;
    wf:input4 data:households ;
    wf:output data:buurten_HH ;
    cct:expression "['        1: R2(Obj, Count);\\n        2: ObjectInfo(_);\\n        join_attr (get_attrL 2) 1']" .

data:n50 wf:applicationOf tools:CalculateObjectVectorAmountRatio ;
    wf:input2 data:buurten_HH ;
    wf:input3 data:buurten_HH_RA ;
    wf:input4 data:buurten_HH ;
    wf:output data:buurten_res_dens ;
    cct:expression "['        1: ObjectInfo(Count);\\n        2: ObjectInfo(Ratio);\\n        join_attr\\n            (get_attrL 1)\\n            (apply2 ratio (get_attrR 1) (get_attrR 2))']" .

data:n6 wf:applicationOf tools:JoinField ;
    wf:input1 data:households ;
    wf:input2 data:buurten ;
    wf:output data:buurten_HH_Temp ;
    rdfs:comment "Join household count data to the buurten attribute table" .

tools:CalculateObjectVectorAmountRatio a wf:Workflow ;
    wf:edge data:n21,
        data:n22 ;
    wf:source data:buurten_HH,
        data:buurten_HH_RA ;
    dct:subject """        1: ObjectInfo(Count);
        2: ObjectInfo(Ratio);
        join_attr
            (get_attrL 1)
            (apply2 ratio (get_attrR 1) (get_attrR 2))""" .

tools:LoadCountAmounts a wf:Workflow ;
    wf:edge data:n0,
        data:n11,
        data:n13,
        data:n6 ;
    wf:source data:Amsterdam_buurt,
        data:households ;
    dct:subject """        1: R2(Obj, Count);
        2: ObjectInfo(_);
        join_attr (get_attrL 2) 1""" .

data:Amsterdam_land a ccd:FieldQ,
        ccd:NominalA,
        ccd:VectorTessellationA ;
    rdfs:comment "Land use dataset of Amsterdam" .

data:buurten_HH_RA2 a ccd:ObjectQ,
        ccd:VectorTessellationA .

data:buurten_HH_Temp a ccd:CountA,
        ccd:ObjectQ,
        ccd:VectorTessellationA .

data:buurten_HH_Temp2 a ccd:CountA,
        ccd:ObjectQ,
        ccd:VectorTessellationA .

data:buurten_res_dens a ccd:ObjectQ,
        ccd:RatioA,
        ccd:VectorTessellationA .

data:residential_area a ccd:FieldQ,
        ccd:NominalA,
        ccd:PlainVectorRegionA .

data:buurten a ccd:NominalA,
        ccd:ObjectQ,
        ccd:VectorTessellationA .

data:Amsterdam_buurt a ccd:NominalA,
        ccd:ObjectQ,
        ccd:VectorTessellationA ;
    rdfs:comment "Vector polygons representing neighborhoods in Amsterdam" .

data:buurten_HH_RA a ccd:ObjectQ,
        ccd:RatioA,
        ccd:VectorTessellationA .

data:households a ccd:CountA,
        ccd:ObjectQ .

data:buurten_HH a ccd:CountA,
        ccd:ObjectQ,
        ccd:VectorTessellationA .

