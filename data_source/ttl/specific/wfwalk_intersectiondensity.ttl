# @Author(s): Eric Top, Enkhbold Nyamsuren, Simon Scheider, 
@prefix ccd: <http://geographicknowledge.de/vocab/CoreConceptData.rdf#> .
@prefix cct: <https://github.com/quangis/cct#> .
@prefix data: <https://github.com/quangis/cct/blob/master/tools/data.ttl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix tools: <https://github.com/quangis/cct/blob/master/tools/tools.ttl#> .
@prefix wf: <http://geographicknowledge.de/vocab/Workflow.rdf#> .

tools:wfwalk_intersectiondensity a wf:Workflow ;
    wf:edge data:n1,
        data:n22,
        data:n24,
        data:n4,
        data:n6,
        data:n8,
        data:n9 ;
    wf:source data:buurten,
        data:streets ;
    rdfs:comment "What is the density of street intersections for each neighbourhood in Amsterdam" .

data:BRdRaReOfInRecInter4 a ccd:ObjectQ,
        ccd:RatioA,
        ccd:VectorTessellationA .

data:n1 wf:applicationOf tools:FeatureVerticesToPoints ;
    wf:input1 data:streets ;
    wf:output data:endpoints .

data:n22 wf:applicationOf tools:CollectEvents ;
    wf:input1 data:endpoints ;
    wf:output data:intersections .

data:n24 wf:applicationOf tools:SelectLayerByAttribute ;
    wf:input1 data:intersections ;
    wf:output data:true_intersection ;
    rdfs:comment "Select only true intersections (with 3 or more streets (Edge count > 2))" .

data:n4 wf:applicationOf tools:SummarizeWithin ;
    wf:input2 data:true_intersection ;
    wf:input3 data:buurten ;
    wf:output data:BRdRaReOfInRecInter ;
    rdfs:comment "Count the number of street intersections in each neighborhood",
        "Counts the number of features from one feature to another based on the spatial relation" ;
    cct:expression "['        1: ObjectInfo(Nom);\\n        2: ObjectInfo(Nom);\\n        join_attr\\n            (get_attrL 2)\\n            (apply1\\n                (ocont (get_attrL 1))\\n                (get_attrL 2)\\n            )']" .

data:n6 wf:applicationOf tools:AddGeometryAttributes ;
    wf:input1 data:BRdRaReOfInRecInter ;
    wf:output data:BRdRaReOfInRecInter2 ;
    rdfs:comment "Calculate the area of each neighborhood" .

data:n8 wf:applicationOf tools:AddField ;
    wf:input1 data:BRdRaReOfInRecInter2 ;
    wf:output data:BRdRaReOfInRecInter3 ;
    rdfs:comment "Add a field for intersection density per neighborhood" .

data:n9 wf:applicationOf tools:CalculateField ;
    wf:input1 data:BRdRaReOfInRecInter3 ;
    wf:output data:BRdRaReOfInRecInter4 ;
    rdfs:comment "Calculate intersection density per neighborhood" .

data:BRdRaReOfInRecInter a ccd:CountA,
        ccd:ObjectQ,
        ccd:VectorTessellationA .

data:buurten a ccd:NominalA,
        ccd:ObjectQ,
        ccd:VectorTessellationA ;
    rdfs:comment "vector polygons representing buurten of Amsterdam to local file" .

data:endpoints a ccd:PointA .

data:intersections a ccd:NominalA,
        ccd:ObjectQ,
        ccd:PointA .

data:streets a ccd:LineA,
        ccd:NominalA,
        ccd:ObjectQ .

data:true_intersection a ccd:NominalA,
        ccd:ObjectQ,
        ccd:PointA .

